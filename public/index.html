<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="robots" content="noindex">
  <title>Requesthub — Send Request</title>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
  <meta name="description" content="Requesthub — send tracked requests, get a token, follow status. Built with Brevo + GitHub Issues." />
  <style>
    :root{
      --bg:#071425;--card:#0b1220;--muted:#98a0b3;--accent:#ffd166;--accent-2:#06b6d4;--glass:rgba(255,255,255,0.03);--success:#16a34a;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;color:#eaf3ff;background:linear-gradient(180deg,#041025 0%, #071426 100%);-webkit-font-smoothing:antialiased}
    .wrap{max-width:1100px;margin:28px auto;padding:20px}
    .grid{display:grid;grid-template-columns:1fr 420px;gap:24px}
    @media (max-width:900px){.grid{grid-template-columns:1fr}}
    .panel{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border-radius:12px;padding:22px;box-shadow:0 6px 30px rgba(2,6,23,0.6);border:1px solid rgba(255,255,255,0.03)}
    .brand{display:flex;align-items:center;gap:12px;margin-bottom:12px}
    .logo{width:54px;height:54px;border-radius:12px;background:linear-gradient(135deg,var(--accent),var(--accent-2));display:flex;align-items:center;justify-content:center;font-weight:800;color:#072029;font-size:20px;box-shadow:0 6px 18px rgba(6,11,27,0.6)}
    h1{margin:0;font-size:20px}
    p.lead{color:var(--muted);margin:6px 0 14px;font-size:14px}
    form .row{margin-bottom:10px}
    input[type="text"],input[type="email"],select,textarea{width:100%;padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,0.03);background:var(--glass);color:#eaf3ff;font-size:14px}
    textarea{min-height:120px;resize:vertical}
    .btn{display:inline-flex;align-items:center;gap:10px;background:linear-gradient(90deg,var(--accent),var(--accent-2));color:#072029;padding:12px 16px;border-radius:10px;border:0;font-weight:700;cursor:pointer}
    .muted{color:var(--muted);font-size:13px}
    .info{font-size:14px;color:var(--muted);padding:12px;border-radius:8px;background:rgba(255,255,255,0.01);border:1px solid rgba(255,255,255,0.02)}
    .token{display:inline-block;padding:6px 10px;border-radius:8px;background:#062433;color:var(--accent);font-weight:700}
    .success{border-left:4px solid var(--success);padding-left:12px;background:linear-gradient(180deg, rgba(16,64,37,0.08), rgba(6,20,16,0.02));}
    .error{border-left:4px solid #ec4899;padding-left:12px;background:linear-gradient(180deg, rgba(64,14,36,0.06), rgba(6,20,16,0.02));}
    footer{margin-top:18px;color:var(--muted);font-size:13px;text-align:center}
    .small{font-size:13px;color:var(--muted)}
    .links a{color:var(--accent);text-decoration:none;font-weight:600}
    .admin-button{background:#112233;color:#dfefff;padding:8px 10px;border-radius:8px;border:1px solid rgba(255,255,255,0.03);cursor:pointer}
    .center{display:flex;align-items:center;justify-content:center}
    .hidden{display:none}
    .spinner{width:16px;height:16px;border-radius:50%;border:2px solid rgba(255,255,255,0.12);border-top-color:var(--accent);animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
  </style>
</head>
<body>
<div class="wrap">
  <div style="display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:18px">
    <div class="brand">
      <div class="logo" aria-hidden>RH</div>
      <div>
        <h1>Requesthub</h1>
        <div class="small">Premium request & appointment gateway</div>
      </div>
    </div>
    <div style="text-align:right">
      <div class="small">Service</div>
      <div style="font-weight:700;color:var(--accent)">vj-gateway</div>
    </div>
  </div>

  <div class="grid">
    <section class="panel" id="mainPanel" aria-labelledby="send-heading">
      <h2 id="send-heading" style="margin:0">Send a Request</h2>
      <p class="lead">Fill the form and you'll receive a secure token by email to track the request.</p>

      <form id="requestForm" novalidate>
        <div class="row"><label class="hidden" for="name">Full name</label><input id="name" name="name" type="text" placeholder="Full name" required autocomplete="name"></div>
        <div class="row"><label class="hidden" for="email">Email</label><input id="email" name="email" type="email" placeholder="Email (used to send token)" required autocomplete="email"></div>
        <div class="row"><label class="hidden" for="purpose">Purpose</label><select id="purpose" name="purpose" required><option value="Question">Question</option><option value="Appointment">Appointment</option><option value="Chat request">Chat request</option><option value="Other">Other</option></select></div>
        <div class="row"><label class="hidden" for="referral">Referral</label><input id="referral" name="referral" type="text" placeholder="Referral code (optional)"></div>
        <div class="row"><label class="hidden" for="message">Message</label><textarea id="message" name="message" placeholder="Write your message" required></textarea></div>
        <div style="display:flex;gap:12px;align-items:center">
          <button id="submitBtn" class="btn" type="submit"><span id="btnText">Send Request</span><span id="btnSpinner" class="spinner hidden" aria-hidden></span></button>
          <div class="muted">We will email your token & tracking link.</div>
        </div>
      </form>

      <div id="result" style="margin-top:16px" aria-live="polite"></div>

      <div style="margin-top:16px" class="info">
        <strong>Pro tips:</strong>
        <ul style="margin:8px 0 0 16px;padding:0;color:var(--muted);line-height:1.5">
          <li>Use a real email to receive the token instantly.</li>
          <li>Referral codes give priority if valid.</li>
          <li>Open the token link to view live updates.</li>
        </ul>
      </div>
    </section>

    <aside class="panel" aria-labelledby="status-heading">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div>
          <div class="small">Status</div>
          <h3 id="status-heading" style="margin:6px 0 0 0">Quick tracker</h3>
        </div>
        <div style="text-align:right">
          <div class="small">Live</div>
          <div style="font-weight:700;color:var(--accent)">SSE</div>
        </div>
      </div>

      <div style="margin-top:14px" class="info" role="status">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div>
            <div class="small">Last token</div>
            <div id="lastToken" class="token">—</div>
          </div>
          <div style="text-align:right">
            <div class="small">Status</div>
            <div id="lastStatus" class="small muted">—</div>
          </div>
        </div>
        <div class="links" style="margin-top:12px">
          <a id="openStatus" href="#" target="_blank" rel="noopener noreferrer" style="display:none">Open status page</a>
          <button id="adminBtn" class="admin-button" aria-haspopup="dialog">Admin panel</button>
        </div>
      </div>

      <div style="margin-top:16px">
        <h4 style="margin:0 0 8px 0">Recent events</h4>
        <div id="eventsBox" class="small muted">No events yet — submit a request to start.</div>
      </div>

      <footer>
        Requesthub • Brevo + GitHub Issues
      </footer>
    </aside>
  </div>
</div>

<!-- Admin modal (simple) -->
<div id="adminModal" class="hidden" role="dialog" aria-modal="true" aria-labelledby="admin-heading" style="position:fixed;inset:0;background:rgba(2,6,23,0.6);align-items:center;justify-content:center;padding:20px">
  <div style="max-width:720px;width:100%;background:#071026;padding:20px;border-radius:12px;border:1px solid rgba(255,255,255,0.03)">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
      <h3 id="admin-heading" style="margin:0">Admin — Update status</h3>
      <button id="closeAdmin" class="admin-button">Close</button>
    </div>
    <p class="small">Enter the admin secret (kept in Render) to update status.</p>
    <div style="display:grid;gap:8px">
      <input id="adminSecret" placeholder="Admin secret" autocomplete="off" />
      <input id="adminToken" placeholder="Request token (VJ-...)" />
      <select id="adminStatus"><option>status:under-review</option><option>status:team-verification</option><option>status:office-verification</option><option>status:approved</option><option>status:appointment</option><option>status:closed</option></select>
      <input id="adminComment" placeholder="Comment (optional)" />
      <div style="display:flex;gap:8px"><button id="adminUpdate" class="btn">Update</button><div id="adminResult" class="small muted"></div></div>
    </div>
  </div>
</div>

<script>
// Helpers
function qs(sel){return document.querySelector(sel)}
function qsa(sel){return Array.from(document.querySelectorAll(sel))}
function escapeHtml(s){ return String(s||'').replace(/[&<>"'`]/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;","`":"&#96;"})[c]) }

(function(){
  const form = qs('#requestForm');
  const result = qs('#result');
  const lastToken = qs('#lastToken');
  const lastStatus = qs('#lastStatus');
  const eventsBox = qs('#eventsBox');
  const openStatus = qs('#openStatus');

  function showMsg(html, kind){ result.innerHTML = '<div class="'+(kind==='ok'?'success':'error')+'">'+html+'</div>'; }

  // button + spinner control
  const submitBtn = qs('#submitBtn');
  const btnText = document.getElementById('btnText') || null;
  const btnSpinner = document.getElementById('btnSpinner') || null;
  let isSending = false;
  function setLoading(v){
    isSending = !!v;
    if(submitBtn) submitBtn.disabled = !!v;
    if(btnSpinner) btnSpinner.classList.toggle('hidden', !v);
    if(btnText) btnText.style.opacity = v?0.6:1;
  }

  form.addEventListener('submit', async (e)=>{
    e.preventDefault();
    if(isSending) return;
    result.innerHTML = '';
    const data = { name: form.name.value.trim(), email: form.email.value.trim(), purpose: form.purpose.value, message: form.message.value.trim(), referral: form.referral.value.trim() || undefined };
    if(!data.name||!data.email||!data.purpose||!data.message){ showMsg('Please fill all required fields','err'); return; }
    if(!/^[^@\s]+@[^@\s]+\.[^@\s]+$/.test(data.email)){ showMsg('Enter a valid email address','err'); return; }
    try{
      setLoading(true);
      const res = await fetch('/api/request', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(data) });
      const j = await res.json().catch(()=>({ error:'invalid-json-response' }));
      if(res.ok && j.ok){ showMsg('<strong>Request created</strong><br/>Token: <span class="token">'+escapeHtml(j.token)+'</span>','ok'); lastToken.textContent = j.token; lastStatus.textContent = 'received'; openStatus.href = j.statusUrl; openStatus.style.display = 'inline-block'; result.scrollIntoView({behavior:'smooth',block:'center'}); try{ localStorage.setItem('rhub_email', data.email) }catch(e){}; form.reset(); }
      else showMsg('Error: '+escapeHtml(j.error||('HTTP '+res.status)),'err');
    }catch(err){ console.error(err); showMsg('Network or server error. Check logs.','err'); }
    finally{ setLoading(false); }
  });

  // Restore email
  try{ const saved = localStorage.getItem('rhub_email'); if(saved) qs('#email').value = saved }catch(e){}

  // SSE
  try{
    const evt = new EventSource('/events');
    evt.onmessage = e => {
      try{
        const msg = JSON.parse(e.data);
        const time = new Date().toLocaleTimeString();
        eventsBox.innerHTML = time + ' — ' + escapeHtml(msg.type + (msg.token?(' • '+msg.token):'')) + '<br/>' + eventsBox.innerHTML;
        if(msg.type === 'status_update' && lastToken.textContent && msg.token === lastToken.textContent){ lastStatus.textContent = msg.new_status || 'updated'; }
        if(msg.type === 'comment' && msg.comment){ eventsBox.innerHTML = '<b>Comment:</b> '+escapeHtml(msg.comment.user)+': '+escapeHtml(msg.comment.body)+'<br/>'+eventsBox.innerHTML; }
      }catch(e){ console.warn('SSE parse', e); }
    };
    evt.onerror = (err)=>{ console.warn('SSE error', err); }
  }catch(e){ console.warn('SSE not supported', e); }

  // Admin modal
  const adminBtn = qs('#adminBtn');
  const adminModal = qs('#adminModal');
  const closeAdmin = qs('#closeAdmin');
  const adminUpdate = qs('#adminUpdate');
  adminBtn.addEventListener('click', ()=> adminModal.style.display = 'flex');
  closeAdmin.addEventListener('click', ()=> adminModal.style.display = 'none');

  adminUpdate.addEventListener('click', async ()=>{
    const sec = qs('#adminSecret').value.trim();
    const token = qs('#adminToken').value.trim();
    const new_status = qs('#adminStatus').value;
    const comment = qs('#adminComment').value.trim();
    if(!sec||!token||!new_status) return qs('#adminResult').textContent = 'fill details';
    try{
      const res = await fetch('/api/admin/update-status', {
        method:'POST', headers:{'Content-Type':'application/json','x-admin-secret':sec}, body: JSON.stringify({ token, new_status, comment })
      });
      const j = await res.json().catch(()=>({ error:'invalid-json' }));
      if(j.ok) qs('#adminResult').textContent = 'updated'; else qs('#adminResult').textContent = 'error: '+(j.error||'');
      adminModal.style.display = 'none';
    }catch(err){ qs('#adminResult').textContent = 'network error'; }
  });

})();
</script>
</body>
</html>
